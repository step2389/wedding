---
// RSVP.astro
import bgImage from '../assets/images/background.jpg';
---

<section id="rsvp" class="relative py-16 sm:py-24 overflow-hidden">
  <!-- Sfondo Immagine coerente con Schedule -->
  <div class="absolute inset-0 z-0"
    style={`background: linear-gradient(to bottom, var(--color-primary) 0%, transparent 20%), url(${bgImage.src});
      background-size: cover;
      background-position: center;`}>
    <div class="absolute inset-0 bg-black/5"></div>
  </div>

  <div class="relative z-10 max-w-xl mx-auto px-4">
    <div 
      class="rounded-[2.5rem] p-8 sm:p-12 shadow-2xl backdrop-blur-md border"
      style="
        background-color: rgba(255, 255, 255, 0.4); 
        border-color: rgba(255, 255, 255, 0.3);
      "
    >
      <header class="text-center mb-8">
        <h2 
          class="text-3xl sm:text-4xl font-semibold tracking-[0.2em] uppercase mb-2"
          style="color: var(--color-secondary); font-family: 'TeX Gyre Termes', serif;"
        >
          Presenza
        </h2>
        <p class="text-sm" style="color: var(--color-secondary); opacity: 0.7;">
          Facci sapere se sarai con noi
        </p>
      </header>

      <form
        action="https://api.web3forms.com/submit"
        method="POST"
        class="flex flex-col gap-5"
      >
        <input type="hidden" name="access_key" value="2bd3aa52-27fe-48ec-9180-a2679432af07" />

        <!-- Nome e Cognome -->
        <div class="flex flex-col gap-1.5">
          <label class="text-[10px] uppercase tracking-widest font-bold ml-1" style="color: var(--color-secondary);">
            Nome e cognome
          </label>
          <input 
            name="name" 
            type="text" 
            required 
            class="w-full rounded-xl border px-4 py-3 bg-white/30 focus:outline-none focus:ring-1" 
            style="
              border-color: color-mix(in srgb, var(--color-secondary), transparent 80%); 
              color: var(--color-secondary);
              outline-color: var(--color-secondary);
            " 
          />
        </div>

        <!-- Email -->
        <div class="flex flex-col gap-1.5">
          <label class="text-[10px] uppercase tracking-widest font-bold ml-1" style="color: var(--color-secondary);">
            Email (opzionale)
          </label>
          <input 
            name="email" 
            type="email" 
            class="w-full rounded-xl border px-4 py-3 bg-white/30 focus:outline-none focus:ring-1" 
            style="
              border-color: color-mix(in srgb, var(--color-secondary), transparent 80%); 
              color: var(--color-secondary);
              outline-color: var(--color-secondary);
            " 
            placeholder="tua@email.com"
          />
        </div>

        <!-- Partecipazione e Ospiti -->
        <div class="grid grid-cols-2 gap-4">
          <div class="flex flex-col gap-1.5">
            <label class="text-[10px] uppercase tracking-widest font-bold ml-1" style="color: var(--color-secondary);">
              Parteciperai?
            </label>
            <select 
              id="attending" 
              name="attending" 
              required 
              class="w-full rounded-xl border px-4 py-3 bg-white/30 focus:outline-none" 
              style="
                border-color: color-mix(in srgb, var(--color-secondary), transparent 80%); 
                color: var(--color-secondary);
              "
            >
              <option value="yes">Sì, ci sarò</option>
              <option value="no">No</option>
            </select>
          </div>
          <div class="flex flex-col gap-1.5">
            <label class="text-[10px] uppercase tracking-widest font-bold ml-1" style="color: var(--color-secondary);">
              Ospiti
            </label>
            <input 
              id="guests" 
              name="guests" 
              type="number" 
              min="1" 
              class="w-full rounded-xl border px-4 py-3 bg-white/30 focus:outline-none" 
              style="
                border-color: color-mix(in srgb, var(--color-secondary), transparent 80%); 
                color: var(--color-secondary);
              " 
            />
          </div>
        </div>

        <!-- Note -->
        <div class="flex flex-col gap-1.5">
          <label class="text-[10px] uppercase tracking-widest font-bold ml-1" style="color: var(--color-secondary);">
            Note o Allergie
          </label>
          <textarea 
            name="notes" 
            rows="3" 
            class="w-full rounded-xl border px-4 py-3 bg-white/30 focus:outline-none" 
            style="
              border-color: color-mix(in srgb, var(--color-secondary), transparent 80%); 
              color: var(--color-secondary);
            "
          ></textarea>
        </div>

        <!-- Bottone Invia -->
        <button
          type="submit"
          class="mt-4 w-full py-4 rounded-full text-xs font-bold uppercase tracking-[0.2em] transition-all hover:brightness-110 active:scale-[0.98] shadow-lg"
          style="
            background-color: var(--color-secondary); 
            color: #ffffff;
          "
        >
          Invia conferma
        </button>

        <input type="hidden" name="redirect" value="https://wedding-anna-stefano.penz23.org/grazie" />
      </form>
    </div>
  </div>
</section>

<script>
  // Funzione per inizializzare il comportamento del form
  const setupRSVP = () => {
    const attendingSelect = document.getElementById("attending") as HTMLSelectElement;
    const guestsInput = document.getElementById("guests") as HTMLInputElement;

    if (!attendingSelect || !guestsInput) return;

    const updateValidation = () => {
      // Controlliamo se il valore è "yes"
      if (attendingSelect.value === "yes") {
        guestsInput.required = true;
        guestsInput.disabled = false;
        guestsInput.placeholder = "Esempio: 1";
        // Effetto visivo: campo attivo
        guestsInput.style.opacity = "1";
        guestsInput.style.cursor = "text";
      } else {
        // Se non partecipa, il campo ospiti non è richiesto e viene pulito
        guestsInput.required = false;
        guestsInput.disabled = true;
        guestsInput.value = "";
        guestsInput.placeholder = "N/A";
        // Effetto visivo: campo "spento"
        guestsInput.style.opacity = "0.4";
        guestsInput.style.cursor = "not-allowed";
      }
    };

    // Ascolta il cambiamento
    attendingSelect.addEventListener("change", updateValidation);
    
    // Esegui al caricamento per impostare lo stato iniziale
    updateValidation();
  };

  // Importante per Astro: esegui lo script anche dopo la navigazione se usi ViewTransitions
  setupRSVP();
  document.addEventListener('astro:after-swap', setupRSVP);
</script>